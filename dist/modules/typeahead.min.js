/**
 * angular-strap
 * @version v2.0.0 - 2014-04-09
 * @link http://mgcrea.github.io/angular-strap
 * @author Olivier Louvignes (olivier@mg-crea.com)
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("mgcrea.ngStrap.typeahead",["mgcrea.ngStrap.tooltip","mgcrea.ngStrap.helpers.parseOptions"]).provider("$typeahead",function(){var e=this.defaults={animation:"am-fade",prefixClass:"typeahead",placement:"bottom-left",template:"typeahead/typeahead.tpl.html",trigger:"focus",container:!1,keyboard:!0,html:!1,delay:0,minLength:1,filter:"filter",limit:6};this.$get=["$window","$rootScope","$tooltip",function(t,n,i){function a(t,n){var a={},o=angular.extend({},e,n),r=o.controller;a=i(t,o);var l,c=n.scope,u=a.$scope;u.$matches=[],u.$activeIndex=0,u.$activate=function(e){u.$$postDigest(function(){a.activate(e)})},u.$select=function(e){u.$$postDigest(function(){a.select(e)})},u.$isVisible=function(){return a.$isVisible()},a.update=function(e){u.$matches=e,u.$activeIndex>=e.length&&(u.$activeIndex=0)},a.activate=function(e){u.$activeIndex=e},a.select=function(e){var n=u.$matches[e].value;r&&(r.$setViewValue(n),r.$render(),c&&c.$digest()),"focus"===o.trigger?t[0].blur():a.$isShown&&a.hide(),u.$activeIndex=0,u.$emit("$typeahead.select",n,e),l=u.$on("tooltip.hide",function(){t.focus()})},a.$isVisible=function(){return o.minLength&&r?u.$matches.length&&angular.isString(r.$viewValue)&&r.$viewValue.length>=o.minLength:!!u.$matches.length},a.$getIndex=function(e){var t=u.$matches.length,n=t;if(t){for(n=t;n--&&u.$matches[n].value!==e;);if(!(0>n))return n}},a.$onMouseDown=function(e){e.preventDefault(),e.stopPropagation()},a.$onKeyDown=function(e){if(l&&l(),/(38|40|13)/.test(e.keyCode)){if(e.preventDefault(),e.stopPropagation(),13===e.keyCode&&u.$matches.length)return a.select(u.$activeIndex);38===e.keyCode&&u.$activeIndex>0?u.$activeIndex--:40===e.keyCode&&u.$activeIndex<u.$matches.length-1?u.$activeIndex++:angular.isUndefined(u.$activeIndex)&&(u.$activeIndex=0),u.$digest()}};var s=a.show;a.show=function(){s(),setTimeout(function(){a.$element.on("mousedown",a.$onMouseDown),o.keyboard&&t.on("keydown",a.$onKeyDown)})};var $=a.hide;return a.hide=function(){a.$element.off("mousedown",a.$onMouseDown),o.keyboard&&t.off("keydown",a.$onKeyDown),$()},a}angular.element(t.document.body);return a.defaults=e,a}]}).directive("bsTypeahead",["$window","$parse","$q","$typeahead","$parseOptions",function(e,t,n,i,a){var o=i.defaults;return{restrict:"EAC",require:"ngModel",link:function(e,t,n,r){var l={scope:e,controller:r};angular.forEach(["placement","container","delay","trigger","keyboard","html","animation","template","filter","limit","minLength"],function(e){angular.isDefined(n[e])&&(l[e]=n[e])});var c=l.filter||o.filter,u=l.limit||o.limit,s=n.ngOptions;c&&(s+=" | "+c+":$viewValue"),u&&(s+=" | limitTo:"+u);var $=a(s),d=i(t,l);e.$watch(n.ngModel,function(t){e.$modelValue=t,$.valuesFn(e,r).then(function(e){e.length>u&&(e=e.slice(0,u)),d.update(e),r.$render()})}),r.$render=function(){if(r.$isEmpty(r.$viewValue))return t.val("");var e=d.$getIndex(r.$modelValue),n=angular.isDefined(e)?d.$scope.$matches[e].label:r.$viewValue;t.val(n.replace(/<(?:.|\n)*?>/gm,"").trim())},e.$on("$destroy",function(){d.destroy(),l=null,d=null})}}}]);